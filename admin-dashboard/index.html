<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="header">
        <h1>üìä Feedback Admin Dashboard</h1>
        <div class="refresh-controls">
            Auto-refresh in: <span id="countdown">30</span>s
            <button onclick="refreshData()">üîÑ Refresh Now</button>
        </div>
    </div>
    
    <div class="stats" id="stats">
        <!-- Stats will load here -->
    </div>
    
    <div class="filters">
        <select id="ratingFilter" onchange="applyFilters()">
            <option value="">‚≠ê All Ratings</option>
            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 Stars</option>
            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 Stars</option>
            <option value="3">‚≠ê‚≠ê‚≠ê 3 Stars</option>
            <option value="2">‚≠ê‚≠ê 2 Stars</option>
            <option value="1">‚≠ê 1 Star</option>
        </select>
        
        <select id="sortFilter" onchange="applyFilters()">
            <option value="desc">üìÖ Newest First</option>
            <option value="asc">üìÖ Oldest First</option>
        </select>
        
        <select id="limitFilter" onchange="applyFilters()">
            <option value="10">10 items</option>
            <option value="25" selected>25 items</option>
            <option value="50">50 items</option>
            <option value="100">100 items</option>
        </select>
        
        <button onclick="clearFilters()">üóëÔ∏è Clear Filters</button>
    </div>
    
    <div id="loading" class="loading">Loading feedback data...</div>
    <div id="error" class="error" style="display: none;"></div>
    
    <div id="feedbackList" class="feedback-list">
        <!-- Feedback items will load here -->
    </div>

    <script>
        let currentFilters = {
            rating: '',
            sort: 'desc',
            limit: '25'
        };
        
        async function loadData() {
            try {
                // Show loading
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                
                // Build query string
                const params = new URLSearchParams();
                if (currentFilters.rating) params.append('rating', currentFilters.rating);
                if (currentFilters.sort) params.append('sort', currentFilters.sort);
                if (currentFilters.limit) params.append('limit', currentFilters.limit);
                
                // Load analytics with current filter
                const analyticsUrl = currentFilters.rating 
                    ? `/api/analytics?rating=${currentFilters.rating}`
                    : '/api/analytics';
                
                const [analyticsRes, feedbackRes] = await Promise.all([
                    fetch(analyticsUrl),
                    fetch(`/api/feedback?${params}`)
                ]);
                
                const analytics = await analyticsRes.json();
                const feedback = await feedbackRes.json();
                
                if (!analytics.success || !feedback.success) {
                    throw new Error('Failed to load data');
                }
                
                // Update stats
                document.getElementById('stats').innerHTML = `
                    <div class="stat-box">
                        <h3>${analytics.data.total}</h3>
                        <p>Total Feedback</p>
                    </div>
                    <div class="stat-box">
                        <h3>${analytics.data.avgRating}</h3>
                        <p>Avg Rating</p>
                    </div>
                    <div class="stat-box">
                        <h3>${analytics.data.recent}</h3>
                        <p>Last 24h</p>
                    </div>
                    <div class="stat-box">
                        <h3>${feedback.count || feedback.data.length}</h3>
                        <p>Showing</p>
                    </div>
                `;
                
                // Update feedback list
                document.getElementById('feedbackList').innerHTML = feedback.data.map(item => `
                    <div class="feedback-item ${item.rating <= 2 ? 'low-rating' : item.rating >= 4 ? 'high-rating' : ''}">
                        <div class="feedback-header">
                            <span class="rating-badge ${item.rating <= 2 ? 'low' : item.rating >= 4 ? 'high' : ''}">
                                ${'‚≠ê'.repeat(item.rating)} (${item.rating}/5)
                            </span>
                            <span class="timestamp">${formatDate(item.created_at)}</span>
                        </div>
                        
                        <div class="review-text ${!item.review ? 'empty' : ''}">
                            <strong>Review:</strong> ${item.review || '(No review text provided)'}
                        </div>
                        
                        <div class="ai-section">
                            <h4>ü§ñ AI Analysis</h4>
                            <p><strong>Summary:</strong> ${item.ai_summary || 'No summary generated'}</p>
                            <p><strong>Recommended Actions:</strong> ${item.ai_actions || 'No actions suggested'}</p>
                        </div>
                        
                        <div class="user-response">
                            <strong>AI Response to User:</strong> ${item.ai_response || 'No response generated'}
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('loading').style.display = 'none';
                
                if (feedback.data.length === 0) {
                    document.getElementById('feedbackList').innerHTML = 
                        '<div class="feedback-item"><p>No feedback found with current filters.</p></div>';
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = 
                    '‚ùå Error loading data. Please check connection and try again.';
            }
        }
        
        function applyFilters() {
            currentFilters.rating = document.getElementById('ratingFilter').value;
            currentFilters.sort = document.getElementById('sortFilter').value;
            currentFilters.limit = document.getElementById('limitFilter').value;
            
            console.log('Applying filters:', currentFilters);
            refreshData();
        }
        
        function clearFilters() {
            document.getElementById('ratingFilter').value = '';
            document.getElementById('sortFilter').value = 'desc';
            document.getElementById('limitFilter').value = '25';
            
            currentFilters = { rating: '', sort: 'desc', limit: '25' };
            refreshData();
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Auto-refresh every 30 seconds
        let countdown = 30;
        let refreshInterval = setInterval(() => {
            countdown--;
            document.getElementById('countdown').textContent = countdown;
            
            if (countdown <= 0) {
                refreshData();
                countdown = 30;
            }
        }, 1000);
        
        function refreshData() {
            loadData();
            countdown = 30;
            document.getElementById('countdown').textContent = countdown;
        }
        
        // Initial load
        loadData();
    </script>
</body>
</html>